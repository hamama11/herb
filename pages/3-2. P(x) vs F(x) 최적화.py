import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="ì˜¨ì‹¤ ë°ì´í„°ë¡œ ë°°ìš°ëŠ” ìµœì í™”", layout="wide")

# -----------------------------
# ì œëª© + íšŒê·€.pyì™€ì˜ ì—°ê²°
# -----------------------------
st.title("ğŸŒ± ì˜¨ì‹¤ ë°ì´í„°ë¡œ ë°°ìš°ëŠ” 'í•¨ìˆ˜ë¥¼ ëª¨ë¥¼ ë•Œ' ìµœì í™”")

st.markdown(
    """
ì´ì „ í˜ì´ì§€(ğŸ“„ *íšŒê·€ì™€ ì†ì‹¤ê³¡ë©´*)ì—ì„œëŠ”

> **ëª¨ë¸ì‹** $p(x; \\theta)$ ê°€ ì£¼ì–´ì ¸ ìˆì„ ë•Œ  
> ê³„ìˆ˜ $\\theta$ë¥¼ ë°”ê¾¸ë©° **ì†ì‹¤ $L(\\theta)$ë¥¼ ìµœì†Œí™”**í•˜ëŠ” ê³¼ì •ì„ ë´¤ìŠµë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” **ì‹¤ì œ í•¨ìˆ˜ì‹ì€ ëª¨ë¥´ê³ , ë°ì´í„°ë§Œ ìˆëŠ” ìƒí™©**ì—ì„œ

1. ë°ì´í„°ë¥¼ ëˆˆìœ¼ë¡œ ë¨¼ì € ì‚´í´ë³´ê³   
2. **íšŒê·€ëª¨ë¸(ë‹¤í•­ì‹)** ë¡œ 'ê°€ì§œ í•¨ìˆ˜'ë¥¼ ë§Œë“¤ê³   
3. ê·¸ ê°€ì§œ í•¨ìˆ˜ ì•ˆì—ì„œ  
   - ìˆ˜í•™ì  ìµœì í™” (ë¯¸ë¶„í•´ì„œ $p'(x)=0$)  
   - ìˆ˜ì¹˜ì  ìµœì í™” (ê²½ì‚¬ ìƒìŠ¹ / gradient ascent)  

ë¥¼ í•´ë³´ë©´ì„œ,  
> â€œí•¨ìˆ˜ë¥¼ ëª¨ë¥¼ ë•Œë„ ê²°êµ­ íšŒê·€ + ìµœì í™”ë¡œ ê°„ë‹¤â€  
ëŠ” íë¦„ì„ ì²´í—˜í•´ ë´…ë‹ˆë‹¤.
"""
)

# -----------------------------
# 1ï¸âƒ£ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° / ìƒ˜í”Œ ìƒì„±
# -----------------------------
st.sidebar.header("ë°ì´í„° ì„¤ì •")

uploaded_file = st.sidebar.file_uploader("ì˜¨ì‹¤ ë°ì´í„° CSV ì—…ë¡œë“œ", type=["csv"])

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)
    st.success("âœ… ì—…ë¡œë“œí•œ ì˜¨ì‹¤ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
else:
    st.info("CSVë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ **ìƒ˜í”Œ ì˜¨ì‹¤ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.**")
    np.random.seed(0)
    # ìƒ˜í”Œ: ì˜¨ë„ 15~35ë„, ìµœì  ì˜¨ë„ 26ë„ ê·¼ì²˜ì—ì„œ ìƒì¥ë¥  ìµœëŒ€
    temperature = np.linspace(15, 35, 60)
    true_opt = 26
    growth_clean = -0.07 * (temperature - true_opt) ** 2 + 1.2
    noise = np.random.normal(0, 0.05, size=temperature.size)
    growth = growth_clean + noise
    humidity = np.random.normal(65, 4, size=temperature.size)

    df = pd.DataFrame(
        {
            "temperature": temperature,
            "humidity": humidity,
            "growth": growth,   # ì˜ˆ: ìƒì¥ë¥ , ì ë©´ì  ì¦ê°€ëŸ‰ ë“±
        }
    )

st.subheader("ğŸ“Š ì˜¨ì‹¤ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(df.head())

# ìˆ«ìì—´ í™•ì¸
numeric_cols = [c for c in df.columns if np.issubdtype(df[c].dtype, np.number)]
if len(numeric_cols) < 2:
    st.error("ìˆ«ìí˜• ì—´ì´ ìµœì†Œ 2ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤ (ì˜ˆ: temperature, growth).")
    st.stop()

# -----------------------------
# 2ï¸âƒ£ x, y ë³€ìˆ˜ ì„ íƒ
# -----------------------------
st.subheader("1ï¸âƒ£ ë¶„ì„í•  ë³€ìˆ˜ ì„ íƒ (x â†’ y)")

col1, col2 = st.columns(2)
with col1:
    x_col = st.selectbox("ì…ë ¥ ë³€ìˆ˜ (x) ì˜ˆ: ì˜¨ë„, ìŠµë„", options=numeric_cols, index=0)
with col2:
    y_candidates = [c for c in numeric_cols if c != x_col]
    y_col = st.selectbox("ê²°ê³¼ ë³€ìˆ˜ (y) ì˜ˆ: ìƒì¥ë¥ , ìˆ˜í™•ëŸ‰", options=y_candidates, index=0)

x = df[x_col].values
y = df[y_col].values

# -----------------------------
# 3ï¸âƒ£ ë°ì´í„° ê·¸ëŒ€ë¡œ ë³´ê¸° (íŒ¨í„´ ê´€ì°°)
# -----------------------------
st.subheader("2ï¸âƒ£ ë°ì´í„° ê·¸ëŒ€ë¡œ ë³´ê¸°: ì¦ê°€ â†’ ê°ì†Œ íŒ¨í„´ì´ ë³´ì´ë‚˜?")

fig1, ax1 = plt.subplots()
ax1.scatter(x, y)
ax1.set_xlabel(x_col)
ax1.set_ylabel(y_col)
ax1.set_title(f"{x_col} vs {y_col}")
st.pyplot(fig1)

st.markdown(
    f"""
- ì•„ì§ **í•¨ìˆ˜ì‹ f(x)** ëŠ” ëª¨ë¥´ëŠ” ìƒíƒœì…ë‹ˆë‹¤.  
- ì—¬ê¸°ì„œëŠ” ê·¸ëƒ¥ ë°ì´í„°ë¥¼ ë³´ë©´ì„œ **íŒ¨í„´ë§Œ ê´€ì°°**í•©ë‹ˆë‹¤.

í•™ìƒë“¤ì—ê²Œ ì´ëŸ° ì§ˆë¬¸ì„ ë˜ì ¸ë³¼ ìˆ˜ ìˆì–´ìš” ğŸ‘‡  

> ğŸ” "{x_col}ê°€ ì»¤ì§ˆìˆ˜ë¡ {y_col}ëŠ” ê³„ì† ì¦ê°€í•˜ë‚˜ìš”?  
>    ì–´ëŠ ì§€ì  ì´í›„ì—ëŠ” ì¤„ì–´ë“œëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ë‚˜ìš”?"
"""
)

# -----------------------------
# 4ï¸âƒ£ ë‹¤í•­ íšŒê·€ë¡œ 'ê°€ì§œ í•¨ìˆ˜' ë§Œë“¤ê¸°
# -----------------------------
st.subheader("3ï¸âƒ£ ë‹¤í•­ì‹ìœ¼ë¡œ ê·¼ì‚¬: ëª¨ë¥´ëŠ” í•¨ìˆ˜ë¥¼ 'ê°€ì§œ í•¨ìˆ˜'ë¡œ ì¶”ë¡ í•˜ê¸°")

degree = st.slider("ë‹¤í•­ì‹ ì°¨ìˆ˜ ì„ íƒ (2~4)", min_value=2, max_value=4, value=2)

# np.polyfitìœ¼ë¡œ ë‹¤í•­ íšŒê·€
coeffs = np.polyfit(x, y, deg=degree)  # ë†’ì€ ì°¨ìˆ˜ë¶€í„° ê³„ìˆ˜
p = np.poly1d(coeffs)                   # ê·¼ì‚¬ í•¨ìˆ˜ p(x)
p_deriv = p.deriv()                     # ë„í•¨ìˆ˜ p'(x)

# ê³¡ì„  ê·¸ë¦¬ê¸°
x_grid = np.linspace(x.min(), x.max(), 400)
y_pred = p(x_grid)

fig2, ax2 = plt.subplots()
ax2.scatter(x, y, alpha=0.5, label="ë°ì´í„°")
ax2.plot(x_grid, y_pred, label=f"ë‹¤í•­ ê·¼ì‚¬ (ì°¨ìˆ˜={degree})")
ax2.set_xlabel(x_col)
ax2.set_ylabel(y_col)
ax2.set_title("ì˜¨ì‹¤ ë°ì´í„° ë‹¤í•­ íšŒê·€ ê·¼ì‚¬")
ax2.legend()
st.pyplot(fig2)

st.markdown(
    f"""
- ì´ì œ ìš°ë¦¬ëŠ” **ì‹¤ì œ í•¨ìˆ˜ f(x)** ëŠ” ëª¨ë¥´ì§€ë§Œ,  
  ë°ì´í„°ë¥¼ ì´ìš©í•´ **ê·¼ì‚¬ í•¨ìˆ˜** \\( \\hat f(x) = p(x) \\) ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.  

ì´ ë¶€ë¶„ì´ ë°”ë¡œ ì´ì „ í˜ì´ì§€(íšŒê·€.py)ì—ì„œ ë´¤ë˜ **ë‹¤í•­ íšŒê·€(polynomial regression)** ì™€ ì—°ê²°ë©ë‹ˆë‹¤.

> ë°ì´í„° â†’ íšŒê·€ëª¨ë¸(ë‹¤í•­ì‹) â†’ ê·¸ ì•ˆì—ì„œ ë‹¤ì‹œ ìµœì í™”
"""
)

# -----------------------------
# 5ï¸âƒ£ (A) ìˆ˜í•™ì  ìµœì í™”: p'(x) = 0 ë‹¨ê³„
# -----------------------------
st.subheader("4ï¸âƒ£ ìˆ˜í•™ì  ìµœì í™”: ê·¼ì‚¬ í•¨ìˆ˜ì˜ ë„í•¨ìˆ˜ pâ€²(x)=0ìœ¼ë¡œ ìµœì ì  ì°¾ê¸°")

# ë„í•¨ìˆ˜ì˜ ê·¼(ë“¤) ì°¾ê¸°
crit_points = np.roots(p_deriv)  # ë³µì†Œê·¼ í¬í•¨
real_crit = crit_points[np.isreal(crit_points)].real
# ë°ì´í„° ë²”ìœ„ ì•ˆì— ìˆëŠ” ì ë§Œ
real_crit_in_range = real_crit[(real_crit >= x.min()) & (real_crit <= x.max())]

if len(real_crit_in_range) > 0:
    # y ê°’ì´ ìµœëŒ€ì¸ ì§€ì ì„ "ìµœì ì " í›„ë³´ë¡œ ì„ íƒ
    xs_opt = real_crit_in_range
    ys_opt = p(xs_opt)
    best_idx = np.argmax(ys_opt)
    x_opt_math = xs_opt[best_idx]
    y_opt_math = ys_opt[best_idx]

    fig3, ax3 = plt.subplots()
    ax3.plot(x_grid, y_pred, label="ë‹¤í•­ ê·¼ì‚¬ p(x)")
    ax3.scatter(x, y, alpha=0.3, label="ë°ì´í„°")
    ax3.scatter([x_opt_math], [y_opt_math], s=80, marker="o", label="ìˆ˜í•™ì  ìµœì ì ")
    ax3.axvline(x_opt_math, linestyle="--")
    ax3.set_xlabel(x_col)
    ax3.set_ylabel(y_col)
    ax3.set_title("ë„í•¨ìˆ˜=0 ì§€ì ì—ì„œ ì°¾ì€ ìµœì ì ")
    ax3.legend()
    st.pyplot(fig3)

    st.write(
        f"**ë„í•¨ìˆ˜ pâ€²(x)=0ì—ì„œ ë‚˜ì˜¨ ìµœì ì  (ê·¼ì‚¬):**  \n"
        f"- {x_col} â‰ˆ **{x_opt_math:.2f}** ì¼ ë•Œ  {y_col} â‰ˆ **{y_opt_math:.3f}**"
    )
else:
    st.warning("ì´ ë‹¤í•­ì‹ì˜ ë„í•¨ìˆ˜=0 ì‹¤ê·¼ì´ ë°ì´í„° êµ¬ê°„ ì•ˆì— ì—†ìŠµë‹ˆë‹¤. (ì°¨ìˆ˜/ë°ì´í„°ë¥¼ ë°”ê¿”ë³´ì„¸ìš”.)")

st.markdown(
    """
- ì—¬ê¸°ê¹Œì§€ê°€ **'ëª¨ë¸ì„ ì„¸ìš´ ë’¤ ë¯¸ë¶„ìœ¼ë¡œ ê·¹ê°’ì„ ì°¾ëŠ”' ìˆ˜í•™ì  ìµœì í™”**ì…ë‹ˆë‹¤.  
- ì›ë˜ í•¨ìˆ˜ f(x)ëŠ” ëª°ë¼ë„, **ê·¼ì‚¬í•¨ìˆ˜ p(x)** ê°€ ìƒê¸°ë©´  

  > pâ€²(x)=0 â†’ ê·¹ê°’ í›„ë³´ â†’ ê·¸ ì¤‘ ìµœëŒ€ì¸ ì§€ì  = ìµœì ì   

  ìœ¼ë¡œ ë…¼ë¦¬ë¥¼ ì „ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"""
)

# -----------------------------
# 6ï¸âƒ£ (B) ìˆ˜ì¹˜ì  ìµœì í™”: ê²½ì‚¬ ìƒìŠ¹(gradient ascent)
# -----------------------------
st.subheader("5ï¸âƒ£ ìˆ˜ì¹˜ì  ìµœì í™”: ê²½ì‚¬(ê¸°ìš¸ê¸°)ë¥¼ ë”°ë¼ í•œ ê±¸ìŒì”© ì˜¬ë¼ê°€ê¸°")

col_g1, col_g2, col_g3 = st.columns(3)
with col_g1:
    x0 = st.slider(
        "ì´ˆê¸°ê°’ xâ‚€ (ì‹œì‘í•˜ëŠ” ìœ„ì¹˜)",
        float(x.min()),
        float(x.max()),
        float(np.median(x)),
        step=float((x.max() - x.min()) / 20),
    )
with col_g2:
    lr = st.slider("í•™ìŠµë¥  (í•œ ë²ˆì— ì´ë™í•˜ëŠ” í¬ê¸°)", 0.001, 0.2, 0.05, 0.001)
with col_g3:
    n_steps = st.slider("ë°˜ë³µ íšŸìˆ˜", 1, 50, 20)

# gradient ascent: x_{k+1} = x_k + lr * p'(x_k)
x_curr = x0
xs_path = [x_curr]
ys_path = [p(x_curr)]

for _ in range(n_steps):
    grad = p_deriv(x_curr)
    x_curr = x_curr + lr * grad  # ìµœëŒ€ê°’ì„ ì°¾ëŠ” 'ê²½ì‚¬ ìƒìŠ¹'
    xs_path.append(x_curr)
    ys_path.append(p(x_curr))

fig4, ax4 = plt.subplots()
ax4.plot(x_grid, y_pred, label="ë‹¤í•­ ê·¼ì‚¬ p(x)")
ax4.scatter(x, y, alpha=0.3, label="ë°ì´í„°")
ax4.plot(xs_path, ys_path, marker="o", linestyle="-", label="ê²½ì‚¬ ìƒìŠ¹ ê²½ë¡œ")
ax4.set_xlabel(x_col)
ax4.set_ylabel(y_col)
ax4.set_title("ê²½ì‚¬ ìƒìŠ¹ìœ¼ë¡œ ê·¼ì‚¬ ìµœì ì ì— ì ‘ê·¼í•˜ëŠ” ê³¼ì •")
ax4.legend()
st.pyplot(fig4)

st.write(
    f"**ê²½ì‚¬ ìƒìŠ¹ í›„ ë§ˆì§€ë§‰ ì  (ê·¼ì‚¬):**  \n"
    f"- {x_col} â‰ˆ **{xs_path[-1]:.2f}**,  {y_col} â‰ˆ **{ys_path[-1]:.3f}**"
)

st.markdown(
    """
- ì´ ê³¼ì •ì´ ë°”ë¡œ **'ìˆ˜ì¹˜ì  ìµœì í™”(gradient ascent)'**ì…ë‹ˆë‹¤.  

- ìˆ˜ì‹ ì „ì²´ë¥¼ ì•Œì§€ ëª»í•´ë„,  
  > 'ì§€ê¸ˆ ìœ„ì¹˜ì—ì„œì˜ ê¸°ìš¸ê¸°'ë¥¼ ì´ìš©í•´  
  > ì¡°ê¸ˆì”© ë” ì¢‹ì€ ë°©í–¥ìœ¼ë¡œ ì›€ì§ì´ëŠ” ì „ëµ  

  ì„ ë°˜ë³µí•˜ë‹¤ ë³´ë©´ **ìµœì ì  ê·¼ì²˜ì— ë„ë‹¬**í•©ë‹ˆë‹¤.  

- ì‹¤ì œ ê¸°ì—…ì˜ AIÂ·ë¨¸ì‹ ëŸ¬ë‹ì—ì„œ ì“°ëŠ”  
  ê²½ì‚¬í•˜ê°•/ê²½ì‚¬ìƒìŠ¹ë²•ë„ ì´ ì›ë¦¬ì…ë‹ˆë‹¤.
"""
)

# -----------------------------
# 7ï¸âƒ£ ë§ˆë¬´ë¦¬ ë¹„êµ
# -----------------------------
st.subheader("6ï¸âƒ£ ì •ë¦¬: í•¨ìˆ˜ ëª¨ë¥¼ ë•Œ ìµœì ì  ì°¾ê¸° 3ë‹¨ê³„ ìš”ì•½")

st.markdown(
    f"""
1. **íŒ¨í„´ ê´€ì°° (EDA)**  
   - ì˜¨ì‹¤ ë°ì´í„°ì—ì„œ {x_col}â€“{y_col} ê·¸ë˜í”„ë¥¼ ë³´ê³   
     â€œì–´ë””ê¹Œì§€ëŠ” ì¦ê°€, ê·¸ ì´í›„ì—ëŠ” ê°ì†Œâ€ì¸ì§€ ëˆˆìœ¼ë¡œ í™•ì¸.

2. **ê·¼ì‚¬ ëª¨ë¸ ë§Œë“¤ê¸° (íšŒê·€)**  
   - ì‹¤ì œ í•¨ìˆ˜ f(x)ëŠ” ëª¨ë¥´ì§€ë§Œ, ë‹¤í•­ì‹ p(x)ë¥¼ í•™ìŠµí•´ì„œ  
     'ê°€ì§œ í•¨ìˆ˜'ë¥¼ ë§Œë“  ë’¤ ê·¸ ì•ˆì—ì„œ ìµœì ì  íƒìƒ‰.

3. **ìµœì í™” ë°©ë²• ì ìš©**  
   - ìˆ˜í•™ì : pâ€²(x)=0ì¸ ì§€ì ë“¤ ì¤‘ì—ì„œ {y_col}ë¥¼ ìµœëŒ€ë¡œ ë§Œë“œëŠ” x ì„ íƒ  
   - ìˆ˜ì¹˜ì : ê¸°ìš¸ê¸° pâ€²(x)ë¥¼ ì´ìš©í•´ xë¥¼ ì¡°ê¸ˆì”© ì´ë™ì‹œí‚¤ë©° ìµœëŒ“ê°’ ê·¼ì²˜ë¡œ ìˆ˜ë ´  

ğŸ‘‰ ì´ë ‡ê²Œ í•˜ë©´ **ì˜¨ì‹¤ ì˜¨ë„/ìŠµë„ì— ëŒ€í•œ ìµœì  ì¡°ê±´**ì„  
   í•¨ìˆ˜ì‹ì„ ëª¨ë¥´ëŠ” ìƒí™©ì—ì„œë„ **ë°ì´í„°ë§Œìœ¼ë¡œ ì¶”ë¡ **í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³ , ì´ê²ƒ ì—­ì‹œ ê²°êµ­

> â€œíšŒê·€ë¡œ ëª¨ë¸ì„ ë§Œë“¤ê³ ,  
>  ê·¸ ëª¨ë¸ ì•ˆì—ì„œ **ìµœì í™”**ë¥¼ í•œë‹¤.â€

ë¼ëŠ” ì ì—ì„œ, ì´ì „ í˜ì´ì§€ì˜ **íšŒê·€.pyì™€ ê°™ì€ í° í‹€** ì•ˆì— ìˆìŠµë‹ˆë‹¤.
"""
)
