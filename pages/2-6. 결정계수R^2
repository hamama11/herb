import streamlit as st
import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import PolynomialFeatures
from sklearn.metrics import r2_score
import plotly.express as px

st.set_page_config(page_title="íšŒê·€ëª¨ë¸ê³¼ ìµœì í™” íƒêµ¬", layout="wide")

st.title("ğŸ“‰ íšŒê·€ëª¨ë¸ê³¼ ìµœì í™” íƒêµ¬")
st.write("""
ë°ì´í„°ì— **ê°€ì¥ ì˜ ë§ëŠ” í•¨ìˆ˜**ë¥¼ ì°¾ëŠ” ë¬¸ì œë¥¼ ìµœì í™” ê´€ì ì—ì„œ íƒêµ¬í•´ë³´ëŠ” ì•±ì…ë‹ˆë‹¤.  
- ì„ í˜• íšŒê·€(ì§ì„ )ì™€ ë‹¤í•­ íšŒê·€(ê³¡ì„ )ë¥¼ ë¹„êµí•´ë³´ê³ ,  
- ì˜¤ì°¨(ì”ì°¨)ì™€ ê²°ì •ê³„ìˆ˜ RÂ²ë¥¼ í†µí•´ ëª¨ë¸ì„ í‰ê°€í•©ë‹ˆë‹¤.  
- ê²½ì‚¬í•˜ê°•ë²•(gradient descent)ìœ¼ë¡œ 'ê¸°ìš¸ê¸° ë°©í–¥ìœ¼ë¡œ ì¡°ê¸ˆì”© ì´ë™í•˜ëŠ”' ìµœì í™” ê³¼ì •ë„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
""")

st.sidebar.header("1. ë°ì´í„° ì„ íƒí•˜ê¸°")

data_option = st.sidebar.radio(
    "ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    ("ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©", "CSV íŒŒì¼ ì—…ë¡œë“œ")
)

if data_option == "ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©":
    # ê°„ë‹¨í•œ ì˜ˆì‹œ ë°ì´í„° ìƒì„± (y = 2x + 3 + ì¡ìŒ)
    np.random.seed(0)
    x = np.linspace(0, 10, 30)
    noise = np.random.normal(0, 2, size=x.shape)
    y = 2 * x + 3 + noise
    df = pd.DataFrame({"x": x, "y": y})
else:
    uploaded_file = st.sidebar.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ (x, y ì—´ í¬í•¨)", type=["csv"])
    if uploaded_file is not None:
        df = pd.read_csv(uploaded_file)
    else:
        st.warning("CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        st.stop()

st.subheader("ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(df.head())

# ì‚°ì ë„
fig_scatter = px.scatter(df, x="x", y="y", title="ë°ì´í„° ì‚°ì ë„")
st.plotly_chart(fig_scatter, use_container_width=True)

st.sidebar.header("2. ëª¨ë¸ ì„¤ì •í•˜ê¸°")

model_type = st.sidebar.selectbox(
    "ëª¨ë¸ ì¢…ë¥˜ ì„ íƒ",
    ["ì„ í˜• íšŒê·€ (1ì°¨)", "ë‹¤í•­ íšŒê·€ (2ì°¨ ì´ìƒ)"]
)

if model_type == "ë‹¤í•­ íšŒê·€ (2ì°¨ ì´ìƒ)":
    degree = st.sidebar.slider("ë‹¤í•­ì‹ ì°¨ìˆ˜ ì„ íƒ", min_value=2, max_value=10, value=2, step=1)
else:
    degree = 1

st.sidebar.header("3. í•™ìŠµ ë°©ë²• ì„ íƒí•˜ê¸°")
train_method = st.sidebar.radio(
    "í•™ìŠµ(ìµœì í™”) ë°©ë²•",
    ("ì •ê·œë°©ì •ì‹ (scikit-learn ì‚¬ìš©)", "ê²½ì‚¬í•˜ê°•ë²• ì§ì ‘ êµ¬í˜„")
)

X = df[["x"]].values
y = df["y"].values

# ë‹¤í•­ íŠ¹ì§• ë³€í™˜
poly = PolynomialFeatures(degree=degree, include_bias=False)
X_poly = poly.fit_transform(X)

# --------------------------
# 1) ì •ê·œë°©ì •ì‹: scikit-learn ì‚¬ìš©
# --------------------------
if train_method == "ì •ê·œë°©ì •ì‹ (scikit-learn ì‚¬ìš©)":
    model = LinearRegression()
    model.fit(X_poly, y)
    y_pred = model.predict(X_poly)

    # ê³„ìˆ˜ í‘œì‹œ
    st.subheader("ğŸ“Œ í•™ìŠµëœ ëª¨ë¸ ì‹")
    coefs = model.coef_
    intercept = model.intercept_

    # ì‹ ë¬¸ìì—´ ë§Œë“¤ê¸°
    terms = []
    for i, c in enumerate(coefs):
        if degree == 1:
            term_str = f"{c:.3f}Â·x"
        else:
            term_str = f"{c:.3f}Â·x^{i+1}"
        terms.append(term_str)
    eq_str = " + ".join(terms)
    st.latex(
        r"\hat{y} = " + f"{intercept:.3f} + " + eq_str
    )

    # R^2 ê³„ì‚°
    r2 = r2_score(y, y_pred)

    st.metric("ê²°ì •ê³„ìˆ˜ RÂ²", f"{r2:.4f}")

    # ì”ì°¨
    residuals = y - y_pred

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("#### ë°ì´í„° vs ì˜ˆì¸¡ê°’")
        df_pred = df.copy()
        df_pred["y_pred"] = y_pred
        fig_fit = px.scatter(df_pred, x="x", y="y", title="ì‹¤ì œê°’ê³¼ ì˜ˆì¸¡ê³¡ì„ ")
        fig_fit.add_traces(
            px.line(df_pred, x="x", y="y_pred").data
        )
        st.plotly_chart(fig_fit, use_container_width=True)

    with col2:
        st.markdown("#### ì”ì°¨ í”Œë¡¯ (ì˜¤ì°¨ ì‹œê°í™”)")
        fig_res = px.scatter(x=df["x"], y=residuals, labels={"x": "x", "y": "ì”ì°¨"})
        fig_res.add_hline(y=0, line_dash="dash")
        st.plotly_chart(fig_res, use_container_width=True)

    st.write("""
    - **ì •ê·œë°©ì •ì‹** ë°©ì‹ì€ ì˜¤ì°¨ ì œê³±í•©ì„ í•œ ë²ˆì— ìµœì†Œë¡œ ë§Œë“œëŠ” ê³„ìˆ˜ë¥¼ ìˆ˜ì‹ìœ¼ë¡œ êµ¬í•œ ê²ƒì…ë‹ˆë‹¤.  
    - ì¦‰, 'ìµœì í™” ê³¼ì •'ì´ ì½”ë“œ ì•ˆì— ìˆ¨ì–´ ìˆì–´ì„œ, í•™ìƒ ëˆˆì—ëŠ” ê³¼ì •ì´ ì˜ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.  
    - ì•„ë˜ì˜ ê²½ì‚¬í•˜ê°•ë²• ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë©´, ì˜¤ì°¨ë¥¼ ì¤„ì—¬ê°€ëŠ” **ê³¼ì •**ì„ ì§ì ‘ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """)

# --------------------------
# 2) ê²½ì‚¬í•˜ê°•ë²• ì§ì ‘ êµ¬í˜„
# --------------------------
else:
    st.subheader("ğŸ§® ê²½ì‚¬í•˜ê°•ë²•ìœ¼ë¡œ ìµœì í™” ê³¼ì • ë³´ê¸° (1ì°¨ì‹ ì „ìš© ë°ëª¨ ì¶”ì²œ)")
    if degree != 1:
        st.info("ê²½ì‚¬í•˜ê°•ë²• êµ¬í˜„ì€ ì—¬ê¸°ì„œëŠ” 1ì°¨ì‹(ì„ í˜• íšŒê·€)ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤. ì°¨ìˆ˜ë¥¼ 1ë¡œ ë‘ê³  ì‹¤í—˜í•´ë³´ì„¸ìš”.")

    lr = st.sidebar.slider("í•™ìŠµë¥ (learning rate)", 0.0001, 0.5, 0.01, step=0.01)
    epochs = st.sidebar.slider("ë°˜ë³µ íšŸìˆ˜(epochs)", 10, 1000, 200, step=10)

    # 1ì°¨ì‹ ê¸°ì¤€ êµ¬í˜„ (y_hat = w x + b)
    x_arr = X.flatten()
    y_arr = y

    # ê°€ì¤‘ì¹˜ ì´ˆê¸°ê°’
    w = st.sidebar.number_input("ì´ˆê¸° ê¸°ìš¸ê¸° w", value=0.0)
    b = st.sidebar.number_input("ì´ˆê¸° ì ˆí¸ b", value=0.0)

    w_hist = []
    b_hist = []
    loss_hist = []

    n = len(x_arr)

    for epoch in range(epochs):
        y_hat = w * x_arr + b
        error = y_hat - y_arr

        # í‰ê· ì œê³±ì˜¤ì°¨(MSE)
        loss = np.mean(error**2)

        # ê¸°ìš¸ê¸°(ê·¸ë˜ë””ì–¸íŠ¸)
        dw = (2/n) * np.sum(error * x_arr)
        db = (2/n) * np.sum(error)

        # íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
        w -= lr * dw
        b -= lr * db

        w_hist.append(w)
        b_hist.append(b)
        loss_hist.append(loss)

    st.markdown("#### ìµœì¢… í•™ìŠµ ê²°ê³¼")
    st.latex(r"\hat{y} = " + f"{w:.3f}x + {b:.3f}")

    y_final = w * x_arr + b
    r2 = r2_score(y_arr, y_final)
    st.metric("ê²°ì •ê³„ìˆ˜ RÂ²", f"{r2:.4f}")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("#### ë°ì´í„° vs ìµœì¢… ì˜ˆì¸¡ ì§ì„ ")
        df_fit = df.copy()
        df_fit["y_pred"] = y_final
        fig_fit = px.scatter(df_fit, x="x", y="y", title="ì‹¤ì œê°’ê³¼ ì˜ˆì¸¡ ì§ì„ ")
        fig_fit.add_traces(
            px.line(df_fit, x="x", y="y_pred").data
        )
        st.plotly_chart(fig_fit, use_container_width=True)

    with col2:
        st.markdown("#### ì†ì‹¤ê°’(MSE) ë³€í™”")
        fig_loss = px.line(y=loss_hist, labels={"x": "epoch", "y": "loss"}, title="ê²½ì‚¬í•˜ê°•ë²• ì†ì‹¤ ê°ì†Œ ê³¼ì •")
        st.plotly_chart(fig_loss, use_container_width=True)

    st.write("""
    - ê²½ì‚¬í•˜ê°•ë²•ì€ **ì˜¤ì°¨ê°€ ì¤„ì–´ë“œëŠ” ë°©í–¥ìœ¼ë¡œ ì¡°ê¸ˆì”© ì´ë™**í•˜ë©° ìµœì ê°’ì— ê°€ê¹Œì›Œì§€ëŠ” ê³¼ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.  
    - í•™ìŠµë¥ ì´ ë„ˆë¬´ í¬ë©´ ë°œì‚°í•˜ê³ , ë„ˆë¬´ ì‘ìœ¼ë©´ ìˆ˜ë ´ì´ ë„ˆë¬´ ëŠë ¤ì§‘ë‹ˆë‹¤.  
    - í•™ìƒì—ê²Œ í•™ìŠµë¥ ì„ ì¡°ì •í•˜ê²Œ í•˜ë©´ì„œ, **ìµœì í™”ì˜ ì•ˆì •ì„±**ê³¼ **ì†ë„**ë¥¼ í•¨ê»˜ íƒêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """)
